# Architecture: Search System

This document describes the end-to-end search system: ingestion, indexing, query processing, ranking, and the hybrid pipeline that combines keyword and vector signals with optional knowledge-graph scoring.

## Components

- Ingestion and normalization
  - Content handlers transform sources into normalized text and metadata.
  - Chunking uses Rabin-based boundaries for deduplication and efficient indexing.
- Storage and metadata
  - Content-addressed storage (SHA-256) with block-level deduplication and compression.
  - Metadata persisted in SQLite; FTS5 virtual tables provide keyword search.
- Vector index
  - Embeddings generated by a configured provider; stored alongside document IDs.
  - Dimension is discovered or validated at runtime; mismatches are rejected.
- Hybrid search engine
  - Combines keyword results with vector similarity; supports tunable weights.
  - Optional Knowledge Graph (KG) scorer can re-rank when a KG store is available.

## Query flow

1. Parse query and extract terms/operators (phrase, field filters) and vectorizable text.
2. Execute keyword search via FTS5 and fuzzy matching helpers (BK-tree, trigrams).
3. If enabled, compute/query vector embeddings and retrieve nearest neighbors.
4. If configured and available, compute KG scores and fuse into final ranking.
5. Merge, deduplicate, and rank results; return with snippets and metadata.

## Configuration highlights

- Hybrid settings: weights for keyword/vector/KG, top-k per stage, and timeouts.
- Vector search: embedding model selection and required dimensionality.
- KG scorer: enabled only when a KnowledgeGraphStore is present.

## Code references

- Search builder and fusion: `src/search/search_engine_builder.cpp`
- Fuzzy/keyword utilities: `src/search/bk_tree.cpp` and related files
- Vector integration and DB: `src/repair/embedding_repair_util.cpp`, `src/vector/dim_resolver.cpp`

See also
- Design: Content Handler Architecture (`docs/design/content-handler-architecture.md`)
- Design: Sync Protocol (`docs/design/sync-protocol.md`)
- API: Search API (`docs/api/search_api.md`)

