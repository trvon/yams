name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main] # Or your default branch
permissions:
  contents: write

jobs:
  warm:
    name: Warm Conan & ccache (matrix)
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
          - arch: armv8
            runs_on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs_on }}
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: false
      - name: Cache Conan packages (warm)
        if: github.actor != 'nektos/act'
        id: cache_conan_warm
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.conan2/p
            ~/.conan2/r
            ~/.conan2/recipes
            ~/.conan2/metadata
            ~/.conan2/s
          key: conan2-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('conanfile.py', 'meson.build', 'meson_options.txt') }}
          restore-keys: |
            conan2-${{ runner.os }}-${{ matrix.arch }}-
            conan2-${{ runner.os }}-
      - name: Cache ccache (warm)
        if: github.actor != 'nektos/act'
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.cache/ccache
            ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('conanfile.py', 'meson.build', 'meson_options.txt') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.arch }}-
            ccache-${{ runner.os }}-
      - name: Install Conan (latest)
        shell: bash
        run: |
          set -euo pipefail
          pipx install conan 2>/dev/null || pip3 install --upgrade conan || python3 -m pip install --upgrade conan || python -m pip install --upgrade conan
          conan --version
          mkdir -p ~/.conan2
          cp .conan/global.conf ~/.conan2/global.conf 2>/dev/null || true
      - name: Prime Conan profiles
        shell: bash
        run: |
          set -euo pipefail
          conan profile detect --force
          sed -i 's/compiler.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
          conan profile show
      - name: Warm Debug dependencies
        shell: bash
        run: |
          set -euo pipefail
          export CONAN_CPU_COUNT=$(nproc || getconf _NPROCESSORS_ONLN || echo 4)
          conan install . -of build/warm-debug -pr:b=default -s build_type=Debug -o yams/*:build_tests=True -o yams/*:enable_onnx=False --build=missing
      - name: Warm summary
        shell: bash
        run: |
          echo "Conan warm cache hit: ${{ steps.cache_conan_warm.outputs.cache-hit }}" || true
          du -sh ~/.conan2/p 2>/dev/null || true
          du -sh ~/.cache/ccache 2>/dev/null || true

  tests:
    needs: warm
    if: ${{ always() }}
    name: Tests (${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
            build_type: Debug
            coverage: true
            extra_meson_flags: "--buildtype=debug -Dbuild-tests=true -Denable-onnx=disabled"
          - arch: armv8
            runs_on: ubuntu-24.04-arm
            build_type: Debug
            coverage: false
            extra_meson_flags: "--buildtype=debug -Dbuild-tests=true -Denable-onnx=disabled"
    runs-on: ${{ matrix.runs_on }}
    # Allow extra time on slower hosted x86_64 runners.
    timeout-minutes: ${{ matrix.arch == 'x86_64' && 75 || 50 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: false  # No submodules required; prevents stale gitlink errors
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          # Provide system Boost as a fallback per docs/BUILD-GCC.md when CMakeDeps resolution
          # is not detected by CMake (module mode will pick this up).
          sudo apt-get install -y --no-install-recommends libboost-all-dev meson
          echo "Installed system Boost headers/libs for module-mode fallback"
      - name: Cache Conan packages
        id: cache_conan
        uses: actions/cache@v4
        with:
          path: |
            ~/.conan2/p
            ~/.conan2/r
            ~/.conan2/recipes
            ~/.conan2/metadata
            ~/.conan2/s
          key: conan2-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('conanfile.py', 'meson.build', 'meson_options.txt') }}
          restore-keys: |
            conan2-${{ runner.os }}-${{ matrix.arch }}-
      - name: Conan cache diagnostics
        shell: bash
        run: |
          echo "Conan cache hit: ${{ steps.cache_conan.outputs.cache-hit }}"
          du -sh ~/.conan2/p 2>/dev/null || true
          ls ~/.conan2/r 2>/dev/null | head || true
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('conanfile.py', 'meson.build', 'meson_options.txt') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.arch }}-
      - name: Install Conan (latest)
        shell: bash
        run: |
          pipx install conan 2>/dev/null || pip3 install --upgrade conan || python3 -m pip install --upgrade conan || python -m pip install --upgrade conan
          conan --version
          mkdir -p ~/.conan2
          cp .conan/global.conf ~/.conan2/global.conf 2>/dev/null || true

      # Continue directly with build/test steps (single job path)
      - name: Set build dir env
        run: echo "BUILD_DIR=build/yams-debug" >> $GITHUB_ENV
      # (Cache & checkout already done above)

      - name: Install optional system dependencies
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends liburing-dev libarchive-dev libtag1-dev ccache || true
          echo "Optional packages installed (best-effort)."

      - name: Setup ccache env
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
            # Limit size to balance cache reuse vs storage
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache -p 2>/dev/null || true
          ccache -z 2>/dev/null || true

      # Conan already installed above

      - name: Setup Conan Profile
        shell: bash
        run: |
          conan profile detect --force
          sed -i 's/compiler.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
          echo "Conan profile configured:" >&2
          conan profile show >&2

      - name: Detect clang version (log only)
        shell: bash
        run: |
          set -euo pipefail
          if command -v clang++ >/dev/null 2>&1; then
            RAW_VER=$(clang++ --version | sed -n 's/.*version \([0-9][0-9]*\).*/\1/p' | head -1 || true)
          elif command -v clang >/dev/null 2>&1; then
            RAW_VER=$(clang --version | sed -n 's/.*version \([0-9][0-9]*\).*/\1/p' | head -1 || true)
          else
            RAW_VER=""
          fi
          if [ -n "$RAW_VER" ]; then
            echo "Detected clang major: $RAW_VER"
          else
            echo "WARNING: clang not found; default profile may resolve gcc instead" >&2
          fi

      - name: Clean corrupted Conan cache if needed
        shell: bash
        run: |
          if ! conan list "*" 2>/dev/null;
          then
            echo "Conan cache appears corrupted, cleaning locks and temp files..."
            conan cache clean --locks --temp 2>/dev/null || true
            echo "Conan cache locks/temp cleaned"
          fi

      - name: Install pkg-config (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew update
          brew install pkg-config cmake ninja || true

      - name: Tune Conan client (parallel downloads)
        shell: bash
        run: |
          set -euo pipefail
          CONF_FILE="$HOME/.conan2/global.conf"
          LINE="core.download:parallel=8"
          mkdir -p "$(dirname "$CONF_FILE")"
          if [ -f "$CONF_FILE" ]; then
            TMP_FILE="$(mktemp)"
            awk -v line="$LINE" '
              BEGIN { replaced = 0 }
              /^core.download:parallel=/ { if (!replaced) { print line; replaced = 1 } ; next }
              { print }
              END { if (!replaced) print line }
            ' "$CONF_FILE" > "$TMP_FILE"
            mv "$TMP_FILE" "$CONF_FILE"
          else
            printf '%s\n' "$LINE" > "$CONF_FILE"
          fi
          echo "Configured $LINE in $CONF_FILE"
          grep -n '^core.download:parallel=' "$CONF_FILE" || true
          conan config show core.download:parallel 2>/dev/null || true
          conan --version

      - name: Configure and Build with Meson
        shell: bash
        run: |
          rm -rf ${{ env.BUILD_DIR }}
          conan install .
            --output-folder=${{ env.BUILD_DIR }}
            -pr:b=default
            -s build_type=Debug
            -o yams/*:build_tests=True
            -o yams/*:enable_onnx=False
            --build=missing
          # Load Conan-generated environment (PKG_CONFIG_PATH, CFLAGS/LDFLAGS, etc.)
          if [ -f "${{ env.BUILD_DIR }}/build-debug/conan/conanrun.sh" ]; then
            source "${{ env.BUILD_DIR }}/build-debug/conan/conanrun.sh"
          fi
          # Relax noisy third-party warnings observed in CI (e.g., sign-compare from gtest)
          export CXXFLAGS="$CXXFLAGS -Wno-sign-compare -Wno-unused-result"
          # Robust Meson toolchain detection across Conan versions
          TOOLCHAIN_DIR="${{ env.BUILD_DIR }}/build-debug/conan"
          NATIVE_FILE="$TOOLCHAIN_DIR/conan_meson_native.ini"
          CROSS_FILE="$TOOLCHAIN_DIR/conan_meson_cross.ini"
          if [ -f "$NATIVE_FILE" ]; then
            MESON_TOOL_ARG=(--native-file "$NATIVE_FILE")
          elif [ -f "$CROSS_FILE" ]; then
            MESON_TOOL_ARG=(--cross-file "$CROSS_FILE")
          else
            echo "Meson toolchain file not found in $TOOLCHAIN_DIR; searching..." >&2
            FOUND=$(find "${{ env.BUILD_DIR }}" -maxdepth 3 -type f \( -name 'conan_meson_native.ini' -o -name 'conan_meson_cross.ini' \) | head -n1)
            if [ -n "$FOUND" ]; then
              case "$FOUND" in
                *native*) MESON_TOOL_ARG=(--native-file "$FOUND") ;;
                *cross*) MESON_TOOL_ARG=(--cross-file "$FOUND") ;;
              esac
            else
              echo "ERROR: Conan Meson toolchain file not found" >&2
              exit 1
            fi
          fi
          meson setup ${{ env.BUILD_DIR }} "${MESON_TOOL_ARG[@]}" -Dwerror=false -Dwarning_level=2 ${{ matrix.extra_meson_flags }}
          meson compile -C ${{ env.BUILD_DIR }}

      - name: Run Tests with Meson
        shell: bash
        run: |
          cd ${{ env.BUILD_DIR }}
          meson test --print-errorlogs

      - name: Generate Coverage Report
        if: matrix.coverage == true
        shell: bash
        run: |
          pip3 install gcovr
          gcovr --root "$GITHUB_WORKSPACE" \
            --exclude 'tests/*' \
            --exclude '_deps/*' \
            --exclude 'build/*' \
            --html --html-details \
            --output "${{ env.BUILD_DIR }}/coverage.html"
          gcovr --root "$GITHUB_WORKSPACE" \
            --exclude 'tests/*' \
            --exclude '_deps/*' \
            --exclude 'build/*' \
            --xml --output "${{ env.BUILD_DIR }}/coverage.xml"
      - name: Upload Coverage Report
        if: matrix.coverage == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.BUILD_DIR }}/coverage.html
          if-no-files-found: error
          retention-days: 5
      - name: Upload Coverage XML
        if: matrix.coverage == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: ${{ env.BUILD_DIR }}/coverage.xml
          if-no-files-found: error
          retention-days: 5
      - name: Upload Benchmark Results
        if: github.actor != 'nektos/act' && matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-linux-hosted-yams
          path: |
            ${{ env.BUILD_DIR }}/bench_results/**/*.json
            ${{ env.BUILD_DIR }}/bench_results/*.json
          if-no-files-found: ignore
          retention-days: 5