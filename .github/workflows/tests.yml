name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main] # Or your default branch
permissions:
  contents: write

jobs:
  tests:
    name: Tests (${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
            host_profile: conan/profiles/host-linux-clang
            build_type: Debug
            coverage: true
            extra_cmake_flags: "-DYAMS_ENABLE_COVERAGE=ON -DYAMS_ENABLE_ONNX=OFF"
          - arch: armv8
            runs_on: ubuntu-24.04-arm
            host_profile: conan/profiles/host-linux-clang-arm
            build_type: Debug
            coverage: false
            extra_cmake_flags: "-DYAMS_ENABLE_COVERAGE=OFF -DYAMS_ENABLE_ONNX=OFF"
    runs-on: ${{ matrix.runs_on }}
    # Allow longer time for first-time ARM dependency builds.
    timeout-minutes: 50
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache Conan packages
        id: cache_conan
        uses: actions/cache@v4
        with:
          path: |
            ~/.conan2/p
            ~/.conan2/r
            ~/.conan2/recipes
            ~/.conan2/metadata
            ~/.conan2/s
          key: conan2-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('conanfile.py', 'CMakePresets.json', matrix.host_profile) }}
          restore-keys: |
            conan2-${{ runner.os }}-${{ matrix.arch }}-
      - name: Conan cache diagnostics
        shell: bash
        run: |
          echo "Conan cache hit: ${{ steps.cache_conan.outputs.cache-hit }}"
          du -sh ~/.conan2/p 2>/dev/null || true
          ls ~/.conan2/r 2>/dev/null | head || true
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('conanfile.py', 'conan.lock', 'CMakePresets.json') }}
          restore-keys: |
            ccache-${{ runner.os }}-
      - name: Install Conan (latest)
        shell: bash
        run: |
          pipx install conan 2>/dev/null || pip3 install --upgrade conan || python3 -m pip install --upgrade conan || python -m pip install --upgrade conan
          conan --version
          mkdir -p ~/.conan2
          cp .conan/global.conf ~/.conan2/global.conf 2>/dev/null || true
      - name: Install Debug deps (pre)
        shell: bash
        run: |
          # Only Debug is required for test job; skipping Release halves cold start time.
          # Disable ONNX to reduce dependency graph & build time.
          conan profile detect --force
          sed -i 's/compiler.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
          export CONAN_CPU_COUNT=$(nproc || getconf _NPROCESSORS_ONLN || echo 4)
          conan install . -of build/warm-debug -pr:h=${{ matrix.host_profile }} -pr:b=default -s build_type=Debug -o yams/*:enable_onnx=False -b missing
      - name: Install Release deps (seed) (x86_64 only)
        if: matrix.arch == 'x86_64'
        shell: bash
        run: |
          export CONAN_CPU_COUNT=$(nproc || getconf _NPROCESSORS_ONLN || echo 4)
          conan install . -of build/warm-release -pr:h=conan/profiles/host-linux-clang -pr:b=default -s build_type=Release -b missing || true

      # Continue directly with build/test steps (single job path)
      - name: Set build dir env
        run: echo "BUILD_DIR=build/yams-debug" >> $GITHUB_ENV
      # (Cache & checkout already done above)

      - name: Install optional system dependencies
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends liburing-dev libarchive-dev libtag1-dev ccache || true
          echo "Optional packages installed (best-effort)."

      - name: Setup ccache env
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
            # Limit size to balance cache reuse vs storage
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache -p 2>/dev/null || true
          ccache -z 2>/dev/null || true

      # Conan already installed above

      - name: Setup Conan Profile
        shell: bash
        run: |
          conan profile detect --force
          sed -i 's/compiler.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
          echo "Conan profile configured:" >&2
          conan profile show >&2

      - name: Detect clang version (log only)
        shell: bash
        run: |
          set -euo pipefail
          if command -v clang++ >/dev/null 2>&1; then
            RAW_VER=$(clang++ --version | sed -n 's/.*version \([0-9][0-9]*\).*/\1/p' | head -1 || true)
          elif command -v clang >/dev/null 2>&1; then
            RAW_VER=$(clang --version | sed -n 's/.*version \([0-9][0-9]*\).*/\1/p' | head -1 || true)
          else
            RAW_VER=""
          fi
          if [ -n "$RAW_VER" ]; then
            echo "Detected clang major: $RAW_VER"
          else
            echo "WARNING: clang not found; default profile may resolve gcc instead" >&2
          fi

      - name: Clean corrupted Conan cache if needed
        shell: bash
        run: |
          if ! conan list "*" 2>/dev/null;
          then
            echo "Conan cache appears corrupted, cleaning locks and temp files..."
            conan cache clean --locks --temp 2>/dev/null || true
            echo "Conan cache locks/temp cleaned"
          fi

      - name: Configure CMake for Debug Build with Tests and Sanitizers (ONNX disabled)
        shell: bash
        run: |
          rm -rf ${{ env.BUILD_DIR }}
          rm -f CMakeUserPresets.json
          conan install . \
            --output-folder=${{ env.BUILD_DIR }} \
            -pr:h=${{ matrix.host_profile }} \
            -pr:b=default \
            -s build_type=Debug \
            -o yams/*:enable_onnx=False \
            --build=missing
          echo "--- Conan generated files (generators) ---"
          GEN_DIR="${{ env.BUILD_DIR }}/build/Debug/generators"
          find "$GEN_DIR" -maxdepth 2 -type f -iname '*boost*' -print || true
          echo "--- Toolchain sanity (first toolchain file if present) ---"
          find ${{ env.BUILD_DIR }} -maxdepth 5 -name conan_toolchain.cmake -print -exec grep -E 'CMAKE_CXX_COMPILER' {} \; | head -20 || true
          # Prepend correct generators dir to CMAKE_PREFIX_PATH to help CMake locate *Config.cmake packages
          export CMAKE_PREFIX_PATH="${GEN_DIR}:${CMAKE_PREFIX_PATH:-}"
          echo "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH"
          # Diagnostic: warn if Boost config is still missing
          if ! compgen -G "$GEN_DIR/*Boost*Config*.cmake" > /dev/null && [ ! -f "$GEN_DIR/boost-config.cmake" ]; then
            echo "WARNING: Boost config not found under $GEN_DIR; verify Conan install graph included boost/1.86.0" >&2
          fi
          cmake --preset yams-debug \
            -DYAMS_BUILD_PROFILE=dev \
            -DYAMS_BUILD_TESTS=ON \
            -DYAMS_ENABLE_SANITIZERS=ON \
            ${{ matrix.extra_cmake_flags }} \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBoost_DIR="$GEN_DIR" \
            -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/stage" # Needed for install step if any
          echo "BUILD_DIR=${{ env.BUILD_DIR }}" >> $GITHUB_ENV # Ensure BUILD_DIR is available for subsequent steps

      - name: Build Project
        shell: bash
        run: |
          cmake --build --preset yams-debug

      - name: ccache stats (post-build)
        shell: bash
        run: |
          ccache -s || echo "ccache not available"

      - name: Run Tests
        shell: bash
        run: |
          cd ${{ env.BUILD_DIR }}
          ctest --output-on-failure -j$(nproc)

      - name: Generate Coverage Report
        if: matrix.coverage == true
        shell: bash
        run: |
          pip3 install gcovr
          gcovr --root "$GITHUB_WORKSPACE" \
            --exclude 'tests/*' \
            --exclude '_deps/*' \
            --exclude 'build/*' \
            --html --html-details \
            --output "${{ env.BUILD_DIR }}/coverage.html"
          gcovr --root "$GITHUB_WORKSPACE" \
            --exclude 'tests/*' \
            --exclude '_deps/*' \
            --exclude 'build/*' \
            --xml --output "${{ env.BUILD_DIR }}/coverage.xml"
      - name: Upload Coverage Report
        if: matrix.coverage == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.arch }}
          path: ${{ env.BUILD_DIR }}/coverage.html
          retention-days: 5
      - name: Upload Coverage XML
        if: matrix.coverage == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-${{ matrix.arch }}
          path: ${{ env.BUILD_DIR }}/coverage.xml
          retention-days: 5
