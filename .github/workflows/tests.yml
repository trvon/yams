name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main] # Or your default branch
permissions:
  contents: read

jobs:
  warm:
    uses: ./.github/workflows/matrix-warm.yml
    with:
      build_type: Debug
      enable_onnx: false

  tests:
    needs: warm
    if: ${{ success() }}
    name: Tests (${{ matrix.suffix }})
    env:
      BUILD_DIR: builddir
    strategy:
      fail-fast: false
      matrix:
        include:
          - suffix: linux-x86_64
            runs_on: ubuntu-24.04
            conan_host_profile: ./conan/profiles/host-linux-clang
            conan_arch: x86_64
            needs_rosetta: false
            build_type: Debug
            coverage: true
            extra_meson_flags: "--buildtype=debug -Dbuild-tests=true -Denable-onnx=disabled"
          - suffix: linux-arm64
            runs_on: ubuntu-24.04-arm
            conan_host_profile: ./conan/profiles/host-linux-clang
            conan_arch: armv8
            needs_rosetta: false
            build_type: Debug
            coverage: false
            extra_meson_flags: "--buildtype=debug -Dbuild-tests=true -Denable-onnx=disabled"
          - suffix: macos-arm64
            runs_on: macos-15
            conan_host_profile: ./conan/profiles/host-macos-apple-clang
            conan_arch: armv8
            needs_rosetta: false
            build_type: Debug
            coverage: false
            extra_meson_flags: "--buildtype=debug -Dbuild-tests=true -Denable-onnx=disabled"
          - suffix: windows-x86_64
            runs_on: windows-latest
            conan_host_profile: ./conan/profiles/host-windows-msvc
            conan_arch: x86_64
            needs_rosetta: false
            build_type: Debug
            coverage: false
            extra_meson_flags: "--buildtype=debug -Dbuild-tests=true -Denable-onnx=disabled"
    runs-on: ${{ matrix.runs_on }}
    # Allow extra time for safety across runners.
    timeout-minutes: 70
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false  # Manual submodule init below (some use SSH URLs)
      - name: Initialize required submodules
        shell: bash
        run: |
          # Only init sqlite-vec-cpp which is required for the build
          # Skip other submodules that use SSH URLs requiring authentication
          git submodule update --init --depth 1 third_party/sqlite-vec-cpp
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          # Provide system Boost as a fallback per docs/BUILD-GCC.md when CMakeDeps resolution
          # is not detected by CMake (module mode will pick this up).
          # Install libbenchmark-dev for Google Benchmark support
          sudo apt-get install -y --no-install-recommends libboost-all-dev meson pkg-config libbenchmark-dev
          echo "Installed system Boost headers/libs for module-mode fallback"
      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew update
          # Align with release workflow to ensure Meson builds have required toolchain bits.
          # Install google-benchmark for benchmark tests
          brew install pkg-config cmake ninja meson ccache boost google-benchmark || true
          # Guard against Homebrew reporting success without linking binaries (nondefault prefixes).
          command -v meson >/dev/null 2>&1 || python3 -m pip install --user --upgrade meson
          command -v ninja >/dev/null 2>&1 || python3 -m pip install --user --upgrade 'ninja>=1.10'
          echo "meson version: $(meson --version || echo 'missing')"
          echo "ninja version: $(ninja --version || echo 'missing')"
      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade meson ninja
          USER_BASE=$(python -m site --user-base)
          export PATH="$USER_BASE/Scripts:$USER_BASE/bin:$PATH"
          echo "meson version: $(meson --version || echo 'missing')"
          echo "ninja version: $(ninja --version || echo 'missing')"
      - name: Cache Conan packages
        id: cache_conan
        uses: actions/cache@v4
        with:
          path: |
            ~/.conan2/p
            ~/.conan2/r
            ~/.conan2/recipes
            ~/.conan2/metadata
            ~/.conan2/s
          key: conan2-${{ runner.os }}-${{ matrix.suffix }}-${{ hashFiles('conanfile.py', 'meson.build', 'meson_options.txt') }}
          restore-keys: |
            conan2-${{ runner.os }}-${{ matrix.suffix }}-
      - name: Conan cache diagnostics
        shell: bash
        run: |
          echo "Conan cache hit: ${{ steps.cache_conan.outputs.cache-hit }}"
          du -sh ~/.conan2/p 2>/dev/null || true
          ls ~/.conan2/r 2>/dev/null | head || true
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.suffix }}-${{ hashFiles('conanfile.py', 'meson.build', 'meson_options.txt') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.suffix }}-
      - name: Install Conan (latest)
        shell: bash
        run: |
          PYTHON_CMD="python3"
          if [ "$RUNNER_OS" = "Windows" ]; then
            PYTHON_CMD="python"
          fi

          if [ "$RUNNER_OS" = "macOS" ]; then
            brew update
            brew install pipx || true
            $PYTHON_CMD -m pipx ensurepath || true
            pipx install --python $PYTHON_CMD conan || pipx install conan
          elif [ "$RUNNER_OS" = "Windows" ]; then
            $PYTHON_CMD -m pip install --user --upgrade pipx || true
            $PYTHON_CMD -m pipx ensurepath || true
            pipx install conan
          else
            $PYTHON_CMD -m pip install --user --upgrade pipx || true
            $PYTHON_CMD -m pipx ensurepath || true
            pipx install --python $PYTHON_CMD conan || pipx install conan || pip3 install --user --upgrade conan
          fi
          
          USER_BASE=$($PYTHON_CMD -m site --user-base 2>/dev/null)
          if [ -d "$USER_BASE/bin" ]; then
             echo "$USER_BASE/bin" >> "$GITHUB_PATH"
             export PATH="$USER_BASE/bin:$PATH"
          fi
          if [ -d "$USER_BASE/Scripts" ]; then
             echo "$USER_BASE/Scripts" >> "$GITHUB_PATH"
             export PATH="$USER_BASE/Scripts:$PATH"
          fi

          [ -d "$HOME/.local/bin" ] && echo "$HOME/.local/bin" >> "$GITHUB_PATH" || true
          export PATH="$HOME/.local/bin:$PATH"
          conan --version
          mkdir -p ~/.conan2
          cp .conan/global.conf ~/.conan2/global.conf 2>/dev/null || true

      # Continue directly with build/test steps (single job path)
      - name: Install optional system dependencies
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends liburing-dev libarchive-dev libtag1-dev ccache || true
          echo "Optional packages installed (best-effort)."

      - name: Setup ccache env
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
            # Limit size to balance cache reuse vs storage
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          ccache -p 2>/dev/null || true
          ccache -z 2>/dev/null || true

      # Conan already installed above

      - name: Setup Conan Profile
        shell: bash
        run: |
          conan profile detect --force
          sed -i 's/compiler.cppstd=.*/compiler.cppstd=20/' ~/.conan2/profiles/default || true
          echo "Conan profile configured:" >&2
          conan profile show >&2

      - name: Detect clang version (log only)
        shell: bash
        run: |
          set -euo pipefail
          if command -v clang++ >/dev/null 2>&1; then
            RAW_VER=$(clang++ --version | sed -n 's/.*version \([0-9][0-9]*\).*/\1/p' | head -1 || true)
          elif command -v clang >/dev/null 2>&1; then
            RAW_VER=$(clang --version | sed -n 's/.*version \([0-9][0-9]*\).*/\1/p' | head -1 || true)
          else
            RAW_VER=""
          fi
          if [ -n "$RAW_VER" ]; then
            echo "Detected clang major: $RAW_VER"
          else
            echo "WARNING: clang not found; default profile may resolve gcc instead" >&2
          fi

      - name: Clean corrupted Conan cache if needed
        shell: bash
        run: |
          if ! conan list "*" 2>/dev/null;
          then
            echo "Conan cache appears corrupted, cleaning locks and temp files..."
            conan cache clean --locks --temp 2>/dev/null || true
            echo "Conan cache locks/temp cleaned"
          fi

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew update || true
          brew install pkg-config cmake ninja meson boost google-benchmark || true
          command -v meson >/dev/null 2>&1 || {
            python3 -m pip install --user --upgrade meson || pip3 install --user --upgrade meson || true
            [ -d "$HOME/.local/bin" ] && echo "$HOME/.local/bin" >> "$GITHUB_PATH" || true
          }
          echo "meson version: $(meson --version || echo 'missing')"
          echo "ninja version: $(ninja --version || echo 'missing')"

      - name: Tune Conan client (parallel downloads)
        shell: bash
        run: |
          set -euo pipefail
          CONF_FILE="$HOME/.conan2/global.conf"
          LINE="core.download:parallel=8"
          mkdir -p "$(dirname "$CONF_FILE")"
          if [ -f "$CONF_FILE" ]; then
            TMP_FILE="$(mktemp)"
            awk -v line="$LINE" '
              BEGIN { replaced = 0 }
              /^core.download:parallel=/ { if (!replaced) { print line; replaced = 1 } ; next }
              { print }
              END { if (!replaced) print line }
            ' "$CONF_FILE" > "$TMP_FILE"
            mv "$TMP_FILE" "$CONF_FILE"
          else
            printf '%s\n' "$LINE" > "$CONF_FILE"
          fi
          echo "Configured $LINE in $CONF_FILE"
          grep -n '^core.download:parallel=' "$CONF_FILE" || true
          conan config show core.download:parallel 2>/dev/null || true
          conan --version

      - name: Configure and Build with Meson (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          ARCH_PREFIX=""
          if [ "${{ matrix.needs_rosetta }}" = "true" ]; then
            softwareupdate --install-rosetta --agree-to-license || true
            ARCH_PREFIX="arch -x86_64"
          fi
          # Keep AF_UNIX socket path short on Linux to avoid sun_path length limits
          if [ "$RUNNER_OS" = "Linux" ]; then
            XDG_RUNTIME_DIR="/run/user/$(id -u)"
            mkdir -p "$XDG_RUNTIME_DIR" || true
            echo "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR" >> "$GITHUB_ENV"
          fi
          # Use setup.sh with CI environment variables for consistent build configuration
          export YAMS_CONAN_HOST_PROFILE="${{ matrix.conan_host_profile }}"
          export YAMS_CONAN_ARCH="${{ matrix.conan_arch }}"
          export YAMS_EXTRA_MESON_FLAGS="${{ matrix.extra_meson_flags }}"

          chmod +x setup.sh
          $ARCH_PREFIX ./setup.sh Debug
          $ARCH_PREFIX meson compile -C builddir

      - name: Configure and Build with Meson (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          YAMS_CONAN_HOST_PROFILE: ${{ matrix.conan_host_profile }}
          YAMS_CONAN_ARCH: ${{ matrix.conan_arch }}
          YAMS_EXTRA_MESON_FLAGS: ${{ matrix.extra_meson_flags }}
        run: |
          .\setup.ps1 Debug

      # - name: Check mobile ABI surface
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     LIB_PATH=$(find "${{ env.BUILD_DIR }}" -type f \( -name 'libyams_mobile*.so' -o -name 'libyams_mobile*.dylib' -o -name 'yams_mobile.dll' \) | head -n1)
      #     if [ -z "$LIB_PATH" ]; then
      #       echo "libyams_mobile shared library not found under ${{ env.BUILD_DIR }}" >&2
      #       exit 1
      #     fi
      #     scripts/ci/check_mobile_abi.sh "$LIB_PATH"

      

      - name: Run Tests with Meson (Unix)
        id: meson_tests_unix
        if: ${{ !matrix.needs_rosetta && runner.os != 'Windows' }}
        shell: bash
        continue-on-error: true
        env:
          YAMS_TEST_SAFE_SINGLE_INSTANCE: "1"
          YAMS_SQLITE_MINIMAL_PRAGMAS: "1"
          YAMS_SQLITE_VEC_INIT_TIMEOUT_MS: "1500"
          YAMS_SQLITE_BUSY_TIMEOUT_MS: "1000"
          YAMS_VDB_IN_MEMORY: "1"
          YAMS_SQLITE_VEC_SKIP_INIT: "1"
          YAMS_DISABLE_VECTORS: "1"
          YAMS_TESTING: "1"
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            mkdir -p "${XDG_RUNTIME_DIR:-/run/user/$(id -u)}" || true
            echo "Using XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
          fi
          # Run only unit and integration tests (exclude bench, stress, daemon-long, etc.)
          meson test -C ${{ env.BUILD_DIR }} --suite unit --suite integration --print-errorlogs

      - name: Run Tests with Meson (Windows)
        id: meson_tests_windows
        if: runner.os == 'Windows'
        shell: pwsh
        continue-on-error: true
        env:
          YAMS_TEST_SAFE_SINGLE_INSTANCE: "1"
          YAMS_SQLITE_MINIMAL_PRAGMAS: "1"
          YAMS_SQLITE_VEC_INIT_TIMEOUT_MS: "1500"
          YAMS_SQLITE_BUSY_TIMEOUT_MS: "1000"
          YAMS_VDB_IN_MEMORY: "1"
          YAMS_SQLITE_VEC_SKIP_INIT: "1"
          YAMS_DISABLE_VECTORS: "1"
          YAMS_TESTING: "1"
        run: |
          # Ensure meson/ninja are on PATH
          $UserBase = python -m site --user-base
          $UserBin = Join-Path $UserBase 'Scripts'
          $env:PATH = "$UserBin;$env:PATH"
          # Run only unit and integration tests (exclude bench, stress, daemon-long, etc.)
          meson test -C ${{ env.BUILD_DIR }} --suite unit --suite integration --print-errorlogs

      - name: Run Tests with Meson (Rosetta x86_64)
        id: meson_tests_rosetta
        if: ${{ matrix.needs_rosetta }}
        shell: bash
        continue-on-error: true
        env:
          YAMS_TEST_SAFE_SINGLE_INSTANCE: "1"
          YAMS_SQLITE_MINIMAL_PRAGMAS: "1"
          YAMS_SQLITE_VEC_INIT_TIMEOUT_MS: "1500"
          YAMS_SQLITE_BUSY_TIMEOUT_MS: "1000"
          YAMS_VDB_IN_MEMORY: "1"
          YAMS_SQLITE_VEC_SKIP_INIT: "1"
          YAMS_DISABLE_VECTORS: "1"
          YAMS_TESTING: "1"
        run: |
          # Ensure Rosetta is present (idempotent)
          softwareupdate --install-rosetta --agree-to-license || true
          # Run only unit and integration tests (exclude bench, stress, daemon-long, etc.)
          arch -x86_64 meson test -C ${{ env.BUILD_DIR }} --suite unit --suite integration --print-errorlogs

      - name: Upload test logs (artifacts)
        if: ${{ steps.meson_tests_unix.outcome == 'failure' || steps.meson_tests_windows.outcome == 'failure' || steps.meson_tests_rosetta.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.suffix }}-${{ github.run_number }}
          path: |
            ${{ env.BUILD_DIR }}/meson-logs/
            ${{ env.BUILD_DIR }}/meson-info/
            ${{ env.BUILD_DIR }}/meson-logs/testlog.txt
            ${{ env.BUILD_DIR }}/build-debug/conan/**/*.log
          if-no-files-found: ignore
          retention-days: 14

      - name: Job Summary (artifacts link)
        if: always()
        shell: bash
        run: |
          echo "### Artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "[View artifacts for this run]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce failure on protected branches
        if: ${{ github.ref_protected && (steps.meson_tests_unix.outcome == 'failure' || steps.meson_tests_windows.outcome == 'failure' || steps.meson_tests_rosetta.outcome == 'failure') }}
        shell: bash
        run: |
          echo "Meson tests reported failures; enforcing job failure for protected branch." >&2
          exit 1

      - name: Generate Coverage Report
        if: matrix.coverage == true
        shell: bash
        run: |
          pip3 install gcovr
          gcovr --root "$GITHUB_WORKSPACE" \
            --exclude 'tests/*' \
            --exclude '_deps/*' \
            --exclude 'build/*' \
            --html --html-details \
            --output "${{ env.BUILD_DIR }}/coverage.html"
          gcovr --root "$GITHUB_WORKSPACE" \
            --exclude 'tests/*' \
            --exclude '_deps/*' \
            --exclude 'build/*' \
            --xml --output "${{ env.BUILD_DIR }}/coverage.xml"
      - name: Upload Coverage Report
        if: matrix.coverage == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.BUILD_DIR }}/coverage.html
          if-no-files-found: error
          retention-days: 5
      - name: Upload Coverage XML
        if: matrix.coverage == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: ${{ env.BUILD_DIR }}/coverage.xml
          if-no-files-found: error
          retention-days: 5
      - name: Upload Benchmark Results
        if: github.actor != 'nektos/act' && matrix.conan_arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-linux-hosted-yams
          path: |
            ${{ env.BUILD_DIR }}/bench_results/**/*.json
            ${{ env.BUILD_DIR }}/bench_results/*.json
          if-no-files-found: ignore
          retention-days: 5
