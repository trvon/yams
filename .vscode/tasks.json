{
	"version": "2.0.0",
	"tasks": [
		{
			"label": "setup (Debug)",
			"type": "shell",
			"windows": {
				"command": ".\\setup.ps1 Debug"
			},
			"linux": {
				"command": "./setup.sh Debug"
			},
			"osx": {
				"command": "./setup.sh Debug"
			},
			"problemMatcher": [],
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			},
			"group": {
				"kind": "build",
				"isDefault": true
			}
		},
		{
			"label": "setup (Release)",
			"type": "shell",
			"windows": {
				"command": ".\\setup.ps1 Release"
			},
			"linux": {
				"command": "./setup.sh Release"
			},
			"osx": {
				"command": "./setup.sh Release"
			},
			"problemMatcher": [],
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			}
		},
		{
			"label": "build (Debug)",
			"type": "shell",
			"windows": {
				"command": "builddir\\build-debug\\conan\\conanbuild.ps1; meson compile -C builddir"
			},
			"linux": {
				"command": "meson compile -C builddir"
			},
			"osx": {
				"command": "meson compile -C builddir"
			},
			"problemMatcher": [
				"$msCompile"
			],
			"group": {
				"kind": "build",
				"isDefault": true
			},
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			}
		},
		{
			"label": "meson-build-debug",
			"type": "shell",
			"windows": {
				"command": "if (Test-Path builddir\\build-debug\\conan\\conanbuild.ps1) { builddir\\build-debug\\conan\\conanbuild.ps1 }; meson compile -C builddir"
			},
			"linux": {
				"command": "meson compile -C builddir"
			},
			"osx": {
				"command": "meson compile -C builddir"
			},
			"problemMatcher": [
				"$msCompile"
			],
			"group": "build",
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			}
		},
		{
			"label": "build (Release)",
			"type": "shell",
			"windows": {
				"command": "build\\release\\build-release\\conan\\conanbuild.ps1; meson compile -C build/release"
			},
			"linux": {
				"command": "meson compile -C build/release"
			},
			"osx": {
				"command": "meson compile -C build/release"
			},
			"problemMatcher": [
				"$msCompile"
			],
			"group": "build",
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			}
		},
		{
			"label": "meson-build-release",
			"type": "shell",
			"windows": {
				"command": "if (Test-Path build\\release\\build-release\\conan\\conanbuild.ps1) { build\\release\\build-release\\conan\\conanbuild.ps1 }; meson compile -C build/release"
			},
			"linux": {
				"command": "meson compile -C build/release"
			},
			"osx": {
				"command": "meson compile -C build/release"
			},
			"problemMatcher": [
				"$msCompile"
			],
			"group": "build",
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			}
		},
		{
			"label": "test (Debug)",
			"type": "shell",
			"dependsOn": [
				"build (Debug)"
			],
			"command": "meson test -C builddir --print-errorlogs",
			"problemMatcher": [
				"$gcc"
			],
			"group": {
				"kind": "test",
				"isDefault": true
			},
			"presentation": {
				"reveal": "always",
				"panel": "shared"
			}
		},
		{
			"label": "clean",
			"type": "shell",
			"windows": {
				"command": "Remove-Item -Recurse -Force builddir,build -ErrorAction SilentlyContinue"
			},
			"linux": {
				"command": "rm -rf builddir build"
			},
			"osx": {
				"command": "rm -rf builddir build"
			},
			"problemMatcher": [],
			"group": "none"
		},
		{
			"label": "local-ci: build image (ubuntu-24.04)",
			"type": "shell",
			"command": "docker build -t yams/local-ci:ubuntu-24.04 -f docker/local-ci/ubuntu.Dockerfile .",
			"problemMatcher": [],
			"group": {
				"kind": "build",
				"isDefault": false
			}
		},
		{
			"label": "local-ci: run meson unit tests (docker)",
			"type": "shell",
			"dependsOn": [
				"local-ci: build image (ubuntu-24.04)"
			],
			"command": "docker run --rm -v ${workspaceFolder}:/work -w /work yams/local-ci:ubuntu-24.04 bash -lc 'scripts/local-ci/run_meson_tests.sh'",
			"problemMatcher": [
				"$gcc"
			],
			"group": "test"
		},
		{
			"label": "local-ci: run daemon-only tests (docker)",
			"type": "shell",
			"dependsOn": [
				"local-ci: build image (ubuntu-24.04)"
			],
			"command": "docker run --rm -v ${workspaceFolder}:/work -w /work yams/local-ci:ubuntu-24.04 bash -lc 'XDG_RUNTIME_DIR=/run/user/$(id -u) mkdir -p \"$XDG_RUNTIME_DIR\" && BUILD_DIR=build/yams-debug conan install . -of \"$BUILD_DIR\" -s build_type=Debug -o \"yams/*:build_tests=True\" --build=missing && meson setup \"$BUILD_DIR\" -Dbuildtype=debug -Dbuild-tests=true -Denable-onnx=disabled && meson compile -C \"$BUILD_DIR\" && meson test -C \"$BUILD_DIR\" --print-errorlogs --no-rebuild --suite unit+isolated --test-args=\"--gtest_filter=DaemonTest.*\"'",
			"problemMatcher": [
				"$gcc"
			],
			"group": "test"
		},
		{
			"label": "local-ci: clean build cache (docker)",
			"type": "shell",
			"command": "docker run --rm -v ${workspaceFolder}:/work -w /work yams/local-ci:ubuntu-24.04 bash -lc 'rm -rf build || true'",
			"problemMatcher": [],
			"group": "none"
		},
		{
			"label": "triage: client timeout cases",
			"type": "shell",
			"command": "for c in \"Client timeout recovery: Immediate EOF detection and retry\" \"Client timeout recovery: Honors YAMS_IPC_TIMEOUT_MS for idle reap\" \"Client timeout recovery: Streaming request connection handling\" \"Client timeout recovery: Connection pool management\" \"Client timeout recovery: Rapid request cycle\" \"Client timeout recovery: Daemon restart handling\" \"Client timeout recovery: Error message quality\" \"Client timeout recovery: Connection refused when daemon down\" \"Client timeout recovery: Shutdown cancels in-flight request\" \"Client timeout recovery: Tag filtering matrix for list and search\"; do echo \"=== $c\"; ./builddir/tests/integration/daemon/yams_client_timeout_recovery_tests_catch2 \"$c\" >/tmp/ctr_case.log 2>&1; code=$?; echo \"exit=$code\"; if [ $code -ne 0 ]; then tail -n 120 /tmp/ctr_case.log; break; fi; done"
		},
		{
			"label": "triage: tsan signatures",
			"type": "shell",
			"command": "rg -n \"SUMMARY: ThreadSanitizer|WARNING: ThreadSanitizer|data race|mutex|signal\" /tmp/ctr_case.log | head -n 120"
		},
		{
			"label": "triage: client-timeout verbose",
			"type": "shell",
			"command": "meson test -C builddir \"yams:client_timeout_recovery\" --print-errorlogs --test-args=\"-s\""
		},
		{
			"label": "triage: find failed assertion",
			"type": "shell",
			"command": "python3 - <<'PY'\nfrom pathlib import Path\ntext=Path('builddir/meson-logs/testlog.txt').read_text(errors='replace')\nfor pat in ['FAILED:', 'failed:', 'REQUIRE(', 'CHECK(', 'Assertion', 'test cases:']:\n    print('\\n--',pat)\n    for i,line in enumerate(text.splitlines(),1):\n        if pat in line:\n            print(i,line)\n            if pat!='test cases:':\n                pass\n            \nPY"
		},
		{
			"label": "triage: failed-line-context",
			"type": "shell",
			"command": "python3 - <<'PY'\nfrom pathlib import Path\nlines=Path('builddir/meson-logs/testlog.txt').read_text(errors='replace').splitlines()\nfor i,l in enumerate(lines):\n    if 'FAILED:' in l:\n        s=max(0,i-6); e=min(len(lines),i+12)\n        print('\\n'.join(f'{j+1}: {lines[j]}' for j in range(s,e)))\n        print('---')\nPY"
		},
		{
			"label": "triage: daemon-shutdown failed line",
			"type": "shell",
			"command": "python3 - <<'PY'\nfrom pathlib import Path\nlines=Path('builddir/meson-logs/testlog.txt').read_text(errors='replace').splitlines()\nfor i,l in enumerate(lines):\n    if 'FAILED:' in l:\n        s=max(0,i-8); e=min(len(lines),i+12)\n        print('\\n'.join(f'{j+1}: {lines[j]}' for j in range(s,e)))\n        print('---')\nPY"
		},
		{
			"label": "triage: daemon-shutdown verbose",
			"type": "shell",
			"command": "meson test -C builddir \"yams:daemon_shutdown_inflight_ops\" --print-errorlogs --test-args=\"-s\" && python3 - <<'PY'\nfrom pathlib import Path\nlines=Path('builddir/meson-logs/testlog.txt').read_text(errors='replace').splitlines()\nfor i,l in enumerate(lines):\n    if 'FAILED:' in l:\n        s=max(0,i-6); e=min(len(lines),i+12)\n        print('\\n'.join(f'{j+1}: {lines[j]}' for j in range(s,e)))\n        print('---')\nPY"
		},
		{
			"label": "stability: daemon-shutdown repeats",
			"type": "shell",
			"command": "for i in 1 2 3; do echo \"RUN $i\"; meson test -C builddir \"yams:daemon_shutdown_inflight_ops\" --print-errorlogs || exit 1; done"
		}
	]
}